// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String
  password            String
  role                String   @default("LOAN_OFFICER")
  branchId            String?
  phoneNumber         String?
  lastLogin           DateTime?
  twoFactorEnabled    Boolean  @default(false)
  mustChangePassword  Boolean  @default(false)
  profileImage        String?
  active              Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  branch            Branch?  @relation(fields: [branchId], references: [id])
  loans             Loan[]   @relation("LoanOfficer")
  payments          Payment[]
  documents         Document[]
  approvals         LoanApproval[]
  disbursements     LoanDisbursement[]
  notifications     Notification[]
  activityLogs      ActivityLog[]
  reportTemplates   ReportTemplate[]
  loginHistory      LoginHistory[]
  devices           UserDevice[]
  sessions          UserSession[]
  securityAlerts    SecurityAlert[]
  kycReviews        KYCVerification[]
  batchJobs         BatchJob[]
}

model Borrower {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  email             String?
  phone             String   @unique
  address           String?
  city              String?
  country           String?
  dateOfBirth       DateTime?
  idNumber          String?  @unique
  employmentStatus  String?
  monthlyIncome     Decimal?
  creditScore       Int?
  gender            String?
  maritalStatus     String?
  nationalId        String?
  taxId             String?
  businessName      String?
  businessType      String?
  photoUrl          String?
  portalPin         String?
  kycVerified       Boolean  @default(false)
  kycVerifiedAt     DateTime?
  blacklisted       Boolean  @default(false)
  blacklistReason   String?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  loans             Loan[]
  accounts          Account[]
  guarantors        Guarantor[]
  fraudChecks       FraudCheck[]
  preference        BorrowerPreference?
  signatureRequests SignatureRequest[]
  kycVerifications  KYCVerification[]
  paymentTransactions PaymentTransaction[]
}

model Loan {
  id                String      @id @default(cuid())
  loanNumber        String      @unique
  borrowerId        String
  loanOfficerId     String
  branchId          String?
  principalAmount   Decimal
  interestRate      Decimal
  termMonths        Int
  startDate         DateTime
  endDate           DateTime
  status            String      @default("PENDING")
  purpose           String?
  notes             String?
  approvalDate      DateTime?
  disbursementDate  DateTime?
  approvalLevel     Int         @default(0)
  requiredApprovals Int         @default(1)
  rejectionReason   String?
  collateralValue   Decimal?
  loanProduct       String?
  currency          String      @default("KES")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  branch            Branch?     @relation(fields: [branchId], references: [id])
  borrower          Borrower    @relation(fields: [borrowerId], references: [id])
  loanOfficer       User        @relation("LoanOfficer", fields: [loanOfficerId], references: [id])
  schedules         LoanSchedule[]
  payments          Payment[]
  collaterals       Collateral[]
  documents         Document[]
  approvals         LoanApproval[]
  disbursement      LoanDisbursement?
  fees              LoanFee[]
  penalties         Penalty[]
  fraudChecks       FraudCheck[]
  signatureRequests SignatureRequest[]
  riskScores        LoanRiskScore[]
  paymentTransactions PaymentTransaction[]
}

model LoanSchedule {
  id                String   @id @default(cuid())
  loanId            String
  dueDate           DateTime
  principalDue      Decimal
  interestDue       Decimal
  feesDue           Decimal  @default(0)
  totalDue          Decimal
  principalPaid     Decimal  @default(0)
  interestPaid      Decimal  @default(0)
  feesPaid          Decimal  @default(0)
  totalPaid         Decimal  @default(0)
  isPaid            Boolean  @default(false)
  paidDate          DateTime?
  lateDays          Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  loan              Loan     @relation(fields: [loanId], references: [id])
  penalties         Penalty[]
}

model Payment {
  id                String        @id @default(cuid())
  loanId            String
  amount            Decimal
  paymentDate       DateTime
  receivedBy        String
  paymentMethod     String
  receiptNumber     String        @unique
  notes             String?
  status            String        @default("COMPLETED")
  principalAmount   Decimal
  interestAmount    Decimal
  feesAmount        Decimal       @default(0)
  reversedBy        String?
  reversedAt        DateTime?
  reversalReason    String?
  isReversed        Boolean       @default(false)
  originalPaymentId String?
  currency          String        @default("KES")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  loan              Loan          @relation(fields: [loanId], references: [id])
  receivedByUser    User          @relation(fields: [receivedBy], references: [id])
  transactionId     String?
  transaction       PaymentTransaction? @relation(fields: [transactionId], references: [id])
}

model Collateral {
  id                String   @id @default(cuid())
  loanId            String
  type              String
  description       String
  estimatedValue    Decimal
  documentUrl       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  loan              Loan     @relation(fields: [loanId], references: [id])
}

model Account {
  id                String          @id @default(cuid())
  accountNumber     String          @unique
  borrowerId        String
  accountType       String
  balance           Decimal         @default(0)
  interestRate      Decimal         @default(0)
  active            Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  borrower          Borrower        @relation(fields: [borrowerId], references: [id])
  transactions      Transaction[]
}

model Transaction {
  id                String          @id @default(cuid())
  accountId         String
  type              String
  amount            Decimal
  balance           Decimal
  description       String?
  transactionDate   DateTime        @default(now())
  createdAt         DateTime        @default(now())

  account           Account         @relation(fields: [accountId], references: [id])
}

model Document {
  id                String   @id @default(cuid())
  loanId            String?
  type              String
  fileName          String
  fileUrl           String
  generatedBy       String
  createdAt         DateTime @default(now())

  loan              Loan?    @relation(fields: [loanId], references: [id])
  generatedByUser   User     @relation(fields: [generatedBy], references: [id])
}

model Setting {
  id                String   @id @default(cuid())
  key               String   @unique
  value             String
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Branch {
  id                String   @id @default(cuid())
  name              String
  code              String   @unique
  address           String?
  city              String?
  phone             String?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  users             User[]
  loans             Loan[]
}

model LoanApproval {
  id                String   @id @default(cuid())
  loanId            String
  approvedBy        String
  approvalLevel     Int
  status            String
  comments          String?
  approvedAt        DateTime?
  createdAt         DateTime @default(now())

  loan              Loan     @relation(fields: [loanId], references: [id])
  approver          User     @relation(fields: [approvedBy], references: [id])
}

model LoanDisbursement {
  id                String   @id @default(cuid())
  loanId            String   @unique
  amount            Decimal
  disbursedBy       String
  disbursementMethod String
  referenceNumber   String?
  bankDetails       String?
  disbursedAt       DateTime
  createdAt         DateTime @default(now())

  loan              Loan     @relation(fields: [loanId], references: [id])
  disbursedByUser   User     @relation(fields: [disbursedBy], references: [id])
}

model Fee {
  id                String   @id @default(cuid())
  name              String
  type              String
  calculationType   String
  amount            Decimal?
  percentage        Decimal?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  loanFees          LoanFee[]
}

model LoanFee {
  id                String   @id @default(cuid())
  loanId            String
  feeId             String
  amount            Decimal
  isPaid            Boolean  @default(false)
  paidAmount        Decimal  @default(0)
  dueDate           DateTime?
  createdAt         DateTime @default(now())

  loan              Loan     @relation(fields: [loanId], references: [id])
  fee               Fee      @relation(fields: [feeId], references: [id])
}

model Penalty {
  id                String   @id @default(cuid())
  loanId            String
  scheduleId        String?
  type              String
  amount            Decimal
  isPaid            Boolean  @default(false)
  paidAmount        Decimal  @default(0)
  reason            String?
  appliedDate       DateTime @default(now())

  loan              Loan     @relation(fields: [loanId], references: [id])
  schedule          LoanSchedule? @relation(fields: [scheduleId], references: [id])
}

model Notification {
  id                String   @id @default(cuid())
  userId            String?
  type              String
  category          String
  title             String
  message           String
  status            String   @default("PENDING")
  sentAt            DateTime?
  createdAt         DateTime @default(now())

  user              User?    @relation(fields: [userId], references: [id])
}

model ActivityLog {
  id                String   @id @default(cuid())
  userId            String
  action            String
  entityType        String?
  entityId          String?
  details           String?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id])
}

model Guarantor {
  id                String   @id @default(cuid())
  borrowerId        String
  firstName         String
  lastName          String
  email             String?
  phone             String
  address           String?
  relationship      String?
  idNumber          String?
  createdAt         DateTime @default(now())

  borrower          Borrower @relation(fields: [borrowerId], references: [id])
}

model FraudCheck {
  id                String   @id @default(cuid())
  borrowerId        String
  loanId            String?
  riskScore         Int
  isSuspicious      Boolean
  flags             String
  details           String?
  checkedAt         DateTime @default(now())

  borrower          Borrower @relation(fields: [borrowerId], references: [id])
  loan              Loan?    @relation(fields: [loanId], references: [id])
}

model BorrowerPreference {
  id                String   @id @default(cuid())
  borrowerId        String   @unique
  preferredChannel  String   @default("EMAIL")
  reminderDaysBefore Int     @default(3)
  receiveMarketing  Boolean  @default(true)

  borrower          Borrower @relation(fields: [borrowerId], references: [id])
}

model ReportTemplate {
  id                String   @id @default(cuid())
  userId            String
  name              String
  reportType        String
  filters           String
  fields            String
  groupBy           String?
  sortBy            String?
  chartType         String?
  isPublic          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id])
}

model LoanProduct {
  id                String   @id @default(cuid())
  name              String   @unique
  code              String   @unique
  description       String?
  minAmount         Decimal
  maxAmount         Decimal
  minTerm           Int
  maxTerm           Int
  interestRate      Decimal
  interestType      String   @default("FLAT") // FLAT, REDUCING_BALANCE
  repaymentFrequency String  @default("MONTHLY")
  gracePeriodDays   Int      @default(0)
  lateFeeType       String?  // FIXED, PERCENTAGE
  lateFeeAmount     Decimal?
  processingFeeType String?  // FIXED, PERCENTAGE
  processingFeeAmount Decimal?
  requiresCollateral Boolean @default(false)
  requiresGuarantor Boolean @default(false)
  minCreditScore    Int?
  currency          String   @default("KES")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model TwoFactorAuth {
  id                String   @id @default(cuid())
  userId            String   @unique
  secret            String
  backupCodes       String?
  verifiedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model SystemSetting {
  id                String   @id @default(cuid())
  category          String
  key               String   @unique
  value             String
  label             String
  description       String?
  type              String   @default("text") // text, number, boolean, json
  isPublic          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model SignatureRequest {
  id                String   @id @default(cuid())
  loanId            String
  borrowerId        String
  token             String   @unique
  documentType      String   @default("LOAN_AGREEMENT")
  status            String   @default("PENDING") // PENDING, SENT, VIEWED, SIGNED, DECLINED, EXPIRED
  signatureData     String?
  signedAt          DateTime?
  viewedAt          DateTime?
  expiresAt         DateTime
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  loan              Loan     @relation(fields: [loanId], references: [id])
  borrower          Borrower @relation(fields: [borrowerId], references: [id])
}

model Investor {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  email             String   @unique
  phone             String
  address           String?
  city              String?
  country           String?
  idNumber          String?  @unique
  taxId             String?
  bankName          String?
  bankAccount       String?
  bankBranch        String?
  notes             String?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  accounts          InvestorAccount[]
  transactions      InvestorTransaction[]
}

model InvestorAccount {
  id                String   @id @default(cuid())
  accountNumber     String   @unique
  investorId        String
  accountType       String   @default("INVESTMENT") // INVESTMENT, SAVINGS
  principalAmount   Decimal  @default(0)
  interestRate      Decimal  @default(0)
  interestEarned    Decimal  @default(0)
  maturityDate      DateTime?
  status            String   @default("ACTIVE") // ACTIVE, MATURED, WITHDRAWN, CLOSED
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  investor          Investor @relation(fields: [investorId], references: [id])
  transactions      InvestorTransaction[]
}

model InvestorTransaction {
  id                String   @id @default(cuid())
  investorId        String
  accountId         String
  type              String   // DEPOSIT, WITHDRAWAL, INTEREST_CREDIT, FEE
  amount            Decimal
  balanceBefore     Decimal
  balanceAfter      Decimal
  description       String?
  referenceNumber   String?
  processedBy       String?
  transactionDate   DateTime @default(now())
  createdAt         DateTime @default(now())

  investor          Investor @relation(fields: [investorId], references: [id])
  account           InvestorAccount @relation(fields: [accountId], references: [id])
}

// ============================================================
// Security Models
// ============================================================

model LoginHistory {
  id              String   @id @default(cuid())
  userId          String
  ipAddress       String?
  userAgent       String?
  deviceType      String?
  browser         String?
  os              String?
  location        String?
  status          String   // SUCCESS, FAILED, BLOCKED
  failureReason   String?
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id])
}

model UserDevice {
  id                String   @id @default(cuid())
  userId            String
  deviceFingerprint String
  deviceName        String?
  deviceType        String?
  browser           String?
  os                String?
  lastIpAddress     String?
  isTrusted         Boolean  @default(false)
  firstSeenAt       DateTime @default(now())
  lastSeenAt        DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id])

  @@unique([userId, deviceFingerprint])
}

model UserSession {
  id              String    @id @default(cuid())
  userId          String
  sessionToken    String    @unique
  deviceId        String?
  ipAddress       String?
  userAgent       String?
  isActive        Boolean   @default(true)
  lastActivity    DateTime  @default(now())
  expiresAt       DateTime
  revokedAt       DateTime?
  revokedReason   String?
  createdAt       DateTime  @default(now())

  user            User      @relation(fields: [userId], references: [id])
}

model IPRule {
  id              String    @id @default(cuid())
  ipAddress       String
  type            String    // WHITELIST, BLACKLIST
  reason          String?
  createdBy       String
  expiresAt       DateTime?
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())

  @@unique([ipAddress, type])
}

model SecurityAlert {
  id              String    @id @default(cuid())
  userId          String
  type            String    // NEW_DEVICE, PASSWORD_CHANGE, FAILED_LOGIN_SPIKE, UNUSUAL_LOCATION, SESSION_REVOKED
  title           String
  message         String
  severity        String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  acknowledged    Boolean   @default(false)
  acknowledgedAt  DateTime?
  metadata        String?
  createdAt       DateTime  @default(now())

  user            User      @relation(fields: [userId], references: [id])
}

// ============================================================
// KYC/AML Models
// ============================================================

model KYCVerification {
  id              String    @id @default(cuid())
  borrowerId      String
  status          String    @default("NOT_STARTED") // NOT_STARTED, PENDING, UNDER_REVIEW, VERIFIED, REJECTED
  submittedAt     DateTime?
  reviewedAt      DateTime?
  reviewedBy      String?
  reviewNotes     String?
  rejectionReason String?

  idFrontUrl      String?
  idBackUrl       String?
  selfieUrl       String?
  proofOfAddress  String?
  documentType    String?   // NATIONAL_ID, PASSPORT, DRIVERS_LICENSE
  documentNumber  String?

  amlCheckStatus  String?   @default("PENDING") // PENDING, CLEAR, FLAGGED
  amlCheckDate    DateTime?
  amlFlags        String?

  // Third-party provider fields
  providerId        String?
  providerName      String?
  providerResult    String?
  providerScore     Int?
  providerVerifiedAt DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  borrower        Borrower  @relation(fields: [borrowerId], references: [id])
  reviewer        User?     @relation(fields: [reviewedBy], references: [id])
}

// ============================================================
// Analytics Models
// ============================================================

model PortfolioSnapshot {
  id                  String   @id @default(cuid())
  snapshotDate        DateTime
  totalLoans          Int
  activeLoans         Int
  totalDisbursed      Decimal
  totalOutstanding    Decimal
  totalCollected      Decimal
  totalOverdue        Decimal
  portfolioAtRisk     Decimal
  averageLoanSize     Decimal
  defaultRate         Decimal
  collectionRate      Decimal
  newLoansCount       Int
  newLoansAmount      Decimal
  writeOffs           Decimal  @default(0)
  branchId            String?
  createdAt           DateTime @default(now())

  @@unique([snapshotDate, branchId])
}

model LoanRiskScore {
  id                  String   @id @default(cuid())
  loanId              String
  riskScore           Int
  riskLevel           String   // LOW, MEDIUM, HIGH, CRITICAL
  factors             String
  predictedDefault    Boolean
  calculatedAt        DateTime @default(now())

  loan                Loan     @relation(fields: [loanId], references: [id])
}

// ============================================================
// Batch Processing Models
// ============================================================

model BatchJob {
  id               String    @id @default(cuid())
  type             String    // LOAN_IMPORT, PAYMENT_IMPORT, BORROWER_IMPORT
  status           String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  fileName         String?
  totalRecords     Int       @default(0)
  processedRecords Int       @default(0)
  successCount     Int       @default(0)
  errorCount       Int       @default(0)
  errors           String?   // JSON array of error details
  createdBy        String
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user             User      @relation(fields: [createdBy], references: [id])
}

// ============================================================
// Payment Transaction Models (M-Pesa, Airtel, Bank)
// ============================================================

model PaymentTransaction {
  id                  String    @id @default(cuid())
  provider            String    // MPESA, AIRTEL, BANK
  transactionType     String    // STK_PUSH, C2B, B2C, BANK_TRANSFER
  checkoutRequestId   String?
  merchantRequestId   String?
  mpesaReceiptNumber  String?
  airtelTransactionId String?
  bankReference       String?
  phoneNumber         String?
  amount              Decimal
  accountReference    String?
  status              String    @default("PENDING") // PENDING, COMPLETED, FAILED, CANCELLED
  resultCode          String?
  resultDesc          String?
  loanId              String?
  borrowerId          String?
  transactionDate     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  loan                Loan?     @relation(fields: [loanId], references: [id])
  borrower            Borrower? @relation(fields: [borrowerId], references: [id])
  payments            Payment[]
}
